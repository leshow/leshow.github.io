<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Unit Type Params</title>
  <meta property="og:title" content="Unit Type Params" />
  <meta name="twitter:title" content="Unit Type Params" />
  <meta name="description" content="Updated: The cs140e hosted on Stanford&rsquo;s servers is down, but Sergio has helpfully put up an archived copy here. I&rsquo;ve changed the links in this post to reflect that.
I always enjoy reading blogs about patterns or tricks people have picked up writing Rust. I&rsquo;ve seen this a few times but not read about it anywhere.
I&rsquo;ve been doing class assignments from Operating Systems cs140e. I highly recommend this class if you know a bit of Rust and would like to try writing some lower level code.">
  <meta property="og:description" content="Updated: The cs140e hosted on Stanford&rsquo;s servers is down, but Sergio has helpfully put up an archived copy here. I&rsquo;ve changed the links in this post to reflect that.
I always enjoy reading blogs about patterns or tricks people have picked up writing Rust. I&rsquo;ve seen this a few times but not read about it anywhere.
I&rsquo;ve been doing class assignments from Operating Systems cs140e. I highly recommend this class if you know a bit of Rust and would like to try writing some lower level code.">
  <meta name="twitter:description" content="Updated: The cs140e hosted on Stanford&rsquo;s servers is down, but Sergio has helpfully put up an archived copy here. I&rsquo;ve changed the links in this post to reflect that.
I always enjoy reading â€¦">
  <meta name="author" content="Evan Cameron"/>
  <link href='https://leshow.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://leshow.github.io/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://leshow.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@evan_cam_" />
  <meta name="twitter:creator" content="@evan_cam_" />
  <meta property="og:url" content="https://leshow.github.io/post/unit_type_pattern/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Esoterically Typed" />

  <meta name="generator" content="Hugo 0.57.2" />
  <link rel="canonical" href="https://leshow.github.io/post/unit_type_pattern/" />
  <link rel="alternate" href="https://leshow.github.io/index.xml" type="application/rss+xml" title="Esoterically Typed">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://leshow.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://leshow.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://leshow.github.io/css/codeblock.css" />




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-145420817-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://leshow.github.io">Esoterically Typed</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Esoterically Typed" href="https://leshow.github.io">
            <img class="avatar-img" src="https://leshow.github.io/img/avatar-icon.png" alt="Esoterically Typed" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Unit Type Params</h1>
                
                
                  <span class="post-meta">
  
  
  <i class="fa fa-calendar-o"></i>&nbsp;Posted on September 10, 2018
  
  
  &nbsp;|&nbsp;
  <i class="fa fa-clock-o"></i> 6 minutes (1212 words)
  
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<p><strong>Updated</strong>: The cs140e hosted on Stanford&rsquo;s servers is down, but Sergio has helpfully put up an archived copy <a href="https://cs140e.sergio.bz/">here</a>. I&rsquo;ve changed the links in this post to reflect that.</p>

<p>I always enjoy reading blogs about patterns or tricks people have picked up writing Rust. I&rsquo;ve seen this a few times but not read about it anywhere.</p>

<p>I&rsquo;ve been doing class assignments from <a href="https://cs140e.sergio.bz/syllabus/">Operating Systems cs140e</a>. I highly recommend this class if you know a bit of Rust and would like to try writing some lower level code. The class involves building bits of an OS for the raspberry pi. It requires some hardware components, and it took me a while to source the parts they used in the class, particularly the CP2102 USB dongle. Links at the end of the article.</p>

<h2 id="the-problem">The problem</h2>

<p><a href="https://cs140e.sergio.bz/assignments/1-shell/">Assignment 1</a> has multiple phases, one of which is to implement parts of the <a href="https://en.wikipedia.org/wiki/XMODEM">Xmodem</a> protocol. Xmodem is used for transferring data through serial interfaces. Although we haven&rsquo;t arrived there yet, I imagine it&rsquo;ll be used for transferring data to pi through the CP2102 dongle.</p>

<p>This is the <code>Xmodem</code> struct as given at the start of the assignment:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Xmodem</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">packet</span>: <span class="kt">u8</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">inner</span>: <span class="nc">R</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">started</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">progress</span>: <span class="nc">ProgressFn</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">type</span> <span class="nc">ProgressFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">noop</span><span class="p">(</span><span class="n">_</span>: <span class="nc">Progress</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></code></pre></div>
<p>Notice <code>ProgressFn</code> is a function pointer. After I completed the assignment, I came back to this. I wanted to show a running progress bar, but with a function pointer I had no ability to capture any outside variables in my <code>ProgressFn</code>. Or at least no way that I knew of. If I wanted to capture variables from another scope, I needed to refactor this into a closure.</p>

<p>There&rsquo;s a lot of solutions on offer here. I could have just stuffed a <code>Box&lt;dyn Fn(ProgressFn)&gt;</code> in the struct and been done with it, and while the Xmodem didn&rsquo;t have no_std, none of the other assignments did allocation and I didn&rsquo;t want to start here. Feeling parsimonious, I decided against boxing altogether.</p>

<h2 id="first-attempt">First attempt</h2>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Xmodem</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w">
</span><span class="w"></span><span class="k">where</span><span class="w">
</span><span class="w">    </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">packet</span>: <span class="kt">u8</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">inner</span>: <span class="nc">R</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">started</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">progress</span>: <span class="nc">F</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>To me, this had a syllogism to it. I want to hold a closure, so I should bound my declaration by that. When you introduce bounds here, they propagate, almost leaking out, to the every impl block afterwards. See if you can spot the problem:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span>::<span class="n">Write</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Xmodem</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">packet</span>: <span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">started</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">inner</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">progress</span>: <span class="nc">progress</span>::<span class="n">noop</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new_with_progress</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Xmodem</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">packet</span>: <span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">started</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">inner</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">progress</span>: <span class="nc">f</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="c1">// and others
</span><span class="c1"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p><code>Xmodem::new</code> is returning <code>progress::noop</code>, our function pointer. Only it&rsquo;s type variable says that it must be a <code>Xmodem&lt;T, F&gt;</code> where F is some <code>Fn(Progress)</code>. Substituting a closure <code>|_: Progress| {}</code> in it&rsquo;s place doesn&rsquo;t help either, it&rsquo;s still choosing some specific trait when there&rsquo;s a more general one in the type signature. Our type <code>F</code> claims to be valid for all <code>Fn</code>, but we&rsquo;re giving it a specific closure/fn pointer. You may recognize this as being an existential type.</p>

<p>Here&rsquo;s the error:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">error<span class="o">[</span>E0308<span class="o">]</span>: mismatched types
   --&gt; src/lib.rs:143:23
    <span class="p">|</span>
<span class="m">143</span> <span class="p">|</span>             progress: progress::noop,
    <span class="p">|</span>                       ^^^^^^^^^^^^^^ expected <span class="nb">type</span> parameter, found fn item
    <span class="p">|</span>
    <span class="o">=</span> note: expected <span class="nb">type</span> <span class="sb">`</span>F<span class="sb">`</span>
               found <span class="nb">type</span> <span class="sb">`</span>fn<span class="o">(</span>progress::Progress<span class="o">)</span> <span class="o">{</span>progress::noop<span class="o">}</span><span class="sb">`</span></code></pre></div>
<h2 id="separate-the-new-impls">Separate the new* impls</h2>

<p>We can get the above to compile by breaking up the <code>new</code> method into it&rsquo;s own impl that&rsquo;s specific about the type it returns:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span>::<span class="n">Write</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Xmodem</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">packet</span>: <span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">started</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">inner</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">progress</span>: <span class="nc">progress</span>::<span class="n">noop</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>However, when you actually go to use this code, it produces a compiler error with a misleading hint:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">error<span class="o">[</span>E0284<span class="o">]</span>: <span class="nb">type</span> annotations required: cannot resolve <span class="sb">`</span>&lt;_ as std::ops::FnOnce&lt;<span class="o">(</span>progress::Progress,<span class="o">)</span>&gt;&gt;::Output <span class="o">==</span> <span class="o">()</span><span class="sb">`</span>
  --&gt; src/tests.rs:51:48
   <span class="p">|</span>
<span class="m">51</span> <span class="p">|</span>     <span class="nb">let</span> <span class="nv">tx_thread</span> <span class="o">=</span> std::thread::spawn<span class="o">(</span>move <span class="o">||</span> Xmodem::transmit<span class="o">(</span><span class="p">&amp;</span>input<span class="o">[</span>..<span class="o">]</span>, rx<span class="o">))</span><span class="p">;</span>
   <span class="p">|</span>                                                ^^^^^^^^^^^^^^^^
   <span class="p">|</span>
note: required by <span class="sb">`</span>&lt;Xmodem&lt;<span class="o">()</span>, F&gt;&gt;::transmit<span class="sb">`</span>
  --&gt; src/lib.rs:41:5
   <span class="p">|</span>
<span class="m">41</span> <span class="p">|</span> /     pub fn transmit&lt;R, W&gt;<span class="o">(</span>data: R, to: W<span class="o">)</span> -&gt; io::Result&lt;usize&gt;
<span class="m">42</span> <span class="p">|</span> <span class="p">|</span>     where
<span class="m">43</span> <span class="p">|</span> <span class="p">|</span>         W: io::Read + io::Write,
<span class="m">44</span> <span class="p">|</span> <span class="p">|</span>         R: io::Read,
<span class="m">45</span> <span class="p">|</span> <span class="p">|</span>     <span class="o">{</span>
<span class="m">46</span> <span class="p">|</span> <span class="p">|</span>         Xmodem::transmit_with_progress<span class="o">(</span>data, to, progress::noop<span class="o">)</span>
<span class="m">47</span> <span class="p">|</span> <span class="p">|</span>     <span class="o">}</span>
   <span class="p">|</span> <span class="p">|</span>_____^</code></pre></div>
<p>You can solve this annotation with <code>Xmodem::&lt;(), fn(Progress) -&gt; ()&gt;::transmit</code>. But every call-site will need to be annotated. If the return type is changed to <code>impl Fn</code>, as in the next section, it asks for an annotation I&rsquo;m not sure how to solve.</p>

<h2 id="using-unit-type-params">Using unit type params</h2>

<p>In the original implementation, <code>Xmodem</code> does something interesting with it&rsquo;s <code>inner</code> value. It&rsquo;s set to an unbounded type parameter <code>R</code>. We can take this approach with <code>F</code>. If anyone has written Haskell, this may look familiar: data types like a binary tree aren&rsquo;t usually bounded by <code>Ord</code> in the declaration, however the functions that interact with it provide an interface to the data that is bounded. I think this is a good strategy if it&rsquo;s available. Keep the actual type declaration as generic as possible, then control the bounds by choosing which methods you make public. Only in the impl are the bounds introduced, and then only on the methods where necessary.</p>

<p>The new <code>Xmodem</code> type:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Xmodem</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">packet</span>: <span class="kt">u8</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">started</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">inner</span>: <span class="nc">R</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">progress</span>: <span class="nc">F</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>and for the implementation:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">impl</span><span class="w"> </span><span class="n">Xmodem</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">transmit</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span>: <span class="nc">R</span><span class="p">,</span><span class="w"> </span><span class="n">to</span>: <span class="nc">W</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w">
</span><span class="w">    </span><span class="k">where</span><span class="w">
</span><span class="w">        </span><span class="n">W</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span>::<span class="n">Write</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="n">R</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Xmodem</span>::<span class="n">transmit_with_progress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">progress</span>::<span class="n">noop</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">transmit_with_progress</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span>: <span class="nc">R</span><span class="p">,</span><span class="w"> </span><span class="n">to</span>: <span class="nc">W</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w">
</span><span class="w">    </span><span class="k">where</span><span class="w">
</span><span class="w">        </span><span class="n">W</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span>::<span class="n">Write</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="n">R</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">transmitter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Xmodem</span>::<span class="n">new_with_progress</span><span class="p">(</span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="c1">//...
</span><span class="c1"></span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="c1">// and others
</span><span class="c1"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span>::<span class="n">Write</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Xmodem</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">packet</span>: <span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">started</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">inner</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">progress</span>: <span class="nc">progress</span>::<span class="n">noop</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>If I had put <code>impl&lt;F&gt; Xmodem&lt;(), F&gt;</code>, I would either have to bound the entire <code>impl</code> block by <code>where F: Fn(Progress)</code>, which gets me back to:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">error<span class="o">[</span>E0284<span class="o">]</span>: <span class="nb">type</span> annotations required: cannot resolve <span class="sb">`</span>&lt;_ as std::ops::FnOnce&lt;<span class="o">(</span>progress::Progress,<span class="o">)</span>&gt;&gt;::Output <span class="o">==</span> <span class="o">()</span><span class="sb">`</span>
  --&gt; src/tests.rs:51:48
   <span class="p">|</span>
<span class="m">51</span> <span class="p">|</span>     <span class="nb">let</span> <span class="nv">tx_thread</span> <span class="o">=</span> std::thread::spawn<span class="o">(</span>move <span class="o">||</span> Xmodem::transmit<span class="o">(</span><span class="p">&amp;</span>input<span class="o">[</span>..<span class="o">]</span>, rx<span class="o">))</span><span class="p">;</span> // &lt;FnOnce&lt;<span class="o">(</span>Progress<span class="o">)</span>&gt;&gt;::Output <span class="o">=</span> <span class="o">()</span></code></pre></div>
<p>Or leave it unbounded, which would cause a compilation error when calling <code>new_with_progress</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="m">106</span> <span class="p">|</span>         <span class="nb">let</span> mut <span class="nv">receiver</span> <span class="o">=</span> Xmodem::new_with_progress<span class="o">(</span>from, f<span class="o">)</span><span class="p">;</span>
    <span class="p">|</span>                            ^^^^^^^^^^^^^^^^^^^^^^^^^ expected an <span class="sb">`</span>Fn&lt;<span class="o">(</span>progress::Progress,<span class="o">)</span>&gt;<span class="sb">`</span> closure, found <span class="sb">`</span>F<span class="sb">`</span></code></pre></div>
<p>Unit&rsquo;s type and value are both <code>()</code>. In this case, we&rsquo;re able to satisfy the type parameters in the impl declaration and still control the bounds on the methods. The catch here is of course, the methods <code>transmit</code> <code>transmit_with_progress</code> and a few others not mentioned here are now only valid when <code>Xmodem::&lt;(), ()&gt;</code>.</p>

<p><strong>EDIT</strong>: I somehow forgot the most important code section of the post!</p>

<p>Using unit as a type param we can write,</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span>::<span class="n">Write</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Xmodem</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">packet</span>: <span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">started</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">inner</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">progress</span>: <span class="nc">progress</span>::<span class="n">noop</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>There&rsquo;s nothing prodigious about <code>()</code>. Any type will do. We could&rsquo;ve written:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span>::<span class="n">Write</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Xmodem</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">packet</span>: <span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">started</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">inner</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">progress</span>: <span class="nc">progress</span>::<span class="n">noop</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>And everything would work just fine. <code>()</code> creates less room for confusion and ambiguity though.</p>

<p>On IRC, an improvement was suggested that makes things a bit more explicit. Using the <code>()</code> type param again on the <code>new</code> impl:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w">
</span><span class="w"></span><span class="k">where</span><span class="w">
</span><span class="w">    </span><span class="n">T</span>: <span class="nc">io</span>::<span class="n">Read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span>::<span class="n">Write</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Xmodem</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">Progress</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Xmodem</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">packet</span>: <span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">started</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">inner</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">progress</span>: <span class="nc">progress</span>::<span class="n">noop</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<h2 id="on-nightly">On Nightly</h2>

<p>I was also directed to this possible solution, which is available on nightly behind a feature flag. This makes it possible to declare a type as existential and circumvent passing <code>()</code> as a type parameter. This is and the previous solution are from talchas:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="cp">#![feature(existential_type)]</span><span class="w">
</span><span class="w"></span><span class="n">existential</span><span class="w"> </span><span class="k">type</span> <span class="nc">ProgressFn</span>: <span class="nb">Fn</span><span class="p">();</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">struct</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">F</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">ProgressFn</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">Foo</span><span class="p">(</span><span class="o">||</span><span class="p">())</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>IMO, this seems closer to ideal. We have the language to tell the type system what&rsquo;s going on.</p>

<h2 id="thank-you">Thank you</h2>

<p>Thanks for reading! The Rust community has been great to me over the last few years. I come from a web background, and never thought I would do anything interesting in a language as low level as Rust. Shout out to all the fine people I&rsquo;ve bothered with questions.</p>

<h3 id="cp2102-dongle">CP2102 dongle</h3>

<p>Be careful when you source this part to get the 5-pin version and not the 6-pin one that seems fairly popular online.</p>

<p>USA: <a href="https://www.amazon.com/HiLetgo-CP2102-Converter-Adapter-Downloader/dp/B00LODGRV8/ref=sr_1_4?s=electronics&amp;ie=UTF8&amp;qid=1536424599&amp;sr=1-4&amp;keywords=cp2102">cp2102</a></p>

<p>Canada: <a href="https://www.amazon.ca/Gikfun-CP2102-Converter-Arduino-EK1110x2C/dp/B07DXDLPMZ/ref=sr_1_5?s=electronics&amp;ie=UTF8&amp;qid=1536424620&amp;sr=1-5&amp;keywords=cp2102&amp;dpID=41qk9Czr2sL&amp;preST=_SY300_QL70_&amp;dpSrc=srch">cp2102</a></p>


        

        
      </article>

      
        <ul class="pager blog-pager">
          
          
            <li class="next">
              <a href="https://leshow.github.io/post/impl_proto_tokio/" data-toggle="tooltip" data-placement="top" title="Protocols in Tokio (i3 IPC)">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
        
      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:cameron.evan@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/leshow" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/evan_cam_" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/evan-cameron" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="leshow.github.io">Evan Cameron</a>
            
          

          &nbsp;&bull;&nbsp;
          2022

          
            &nbsp;&bull;&nbsp;
            <a href="https://leshow.github.io">Esoterically Typed</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.57.2</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://leshow.github.io/js/main.js"></script>
<script src="https://leshow.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="https://leshow.github.io/js/load-photoswipe.js"></script>






  </body>
</html>

